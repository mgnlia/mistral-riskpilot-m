#!/usr/bin/env node

import { execSync } from "node:child_process";
import { mkdirSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, "..");
const outputPath = path.join(repoRoot, "lib", "build-info.generated.ts");

function readGitCommitSha() {
  try {
    return execSync("git rev-parse HEAD", {
      cwd: repoRoot,
      stdio: ["ignore", "pipe", "ignore"]
    })
      .toString()
      .trim();
  } catch {
    return null;
  }
}

const buildUtc = new Date().toISOString();
const gitCommitSha =
  process.env.VERCEL_GIT_COMMIT_SHA || process.env.GITHUB_SHA || readGitCommitSha() || "unknown";
const gitCommitRef = process.env.VERCEL_GIT_COMMIT_REF || process.env.GITHUB_REF_NAME || "unknown";
const vercelEnv = process.env.VERCEL_ENV || process.env.NODE_ENV || "unknown";
const vercelProjectProductionUrl = process.env.VERCEL_PROJECT_PRODUCTION_URL || null;

const content = `// Auto-generated by scripts/generate-build-info.mjs\nexport const BUILD_INFO = Object.freeze({\n  buildUtc: ${JSON.stringify(buildUtc)},\n  gitCommitSha: ${JSON.stringify(gitCommitSha)},\n  gitCommitRef: ${JSON.stringify(gitCommitRef)},\n  vercelEnv: ${JSON.stringify(vercelEnv)},\n  vercelProjectProductionUrl: ${JSON.stringify(vercelProjectProductionUrl)}\n});\n`;

mkdirSync(path.dirname(outputPath), { recursive: true });
writeFileSync(outputPath, content, "utf8");
console.log(`âœ… Generated ${path.relative(repoRoot, outputPath)}`);
