#!/usr/bin/env node

import { readFileSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, "..");
const tsConfigPath = path.join(repoRoot, "next.config.ts");
const mjsConfigPath = path.join(repoRoot, "next.config.mjs");

try {
  const tsConfig = readFileSync(tsConfigPath, "utf8");
  const transpiled = tsConfig
    .replace(/^\s*import\s+type\s+\{\s*NextConfig\s*\}\s+from\s+["']next["'];?\s*$/m, "")
    .replace(/:\s*NextConfig\s*=\s*/g, " = ")
    .replace(/export default\s+nextConfig\s*;?\s*$/m, "export default nextConfig;");

  writeFileSync(
    mjsConfigPath,
    `// Auto-generated by scripts/prepare-next-config.mjs for Vercel compatibility.\n${transpiled}\n`,
    "utf8"
  );

  console.log("✅ Generated next.config.mjs from next.config.ts");
} catch (error) {
  const message = error instanceof Error ? error.message : String(error);
  console.error("❌ Failed to generate next.config.mjs:", message);
  process.exit(1);
}
